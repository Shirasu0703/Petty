<% if @review.errors.any? %>
  <%= @review.errors.count %>件のエラーが発生しました
  <ul>
    <% @review.errors.full_messages.each do |message| %>
      <li><%= message %></li>
    <% end %>
  </ul>
<% end %>

<h2 class="text-center my-4">レビュー投稿画面</h2>
<div class="review-background d-flex justify-content-center align-items-center min-vh-100">
  <div class="card shadow-lg border-0" style="max-width: 700px; width: 90%; background: rgba(255, 255, 255, 0.9);">


  <%= form_with model: [@hospital, @review], url: public_hospital_reviews_path, method: :post do |f| %>
  <div class="card-body">
    <div class="mb-3">
      <strong><%= f.label :cleanliness_rating, "清潔さ" %></strong>
      <div id="cleanliness_rating" class="my-2 rate"></div>
      <p class="text-muted mb-0"><%= f.text_field :cleanliness_comment, class: "form-control", placeholder: "清潔さについてコメントしてください" %></p>
    </div>

    <div class="mb-3">
      <strong><%= f.label :doctor_rating, "先生の対応" %></strong>
      <div id="doctor_rating" class="my-2 rate"></div>
      <p class="text-muted mb-0"><%= f.text_field :doctor_comment, class: "form-control", placeholder: "先生の対応についてコメントしてください" %></p>
    </div>

    <div class="mb-3">
      <strong><%= f.label :staff_rating, "スタッフの対応" %></strong>
      <div id="staff_rating" class="my-2 rate"></div>
      <p class="text-muted mb-0"><%= f.text_field :staff_comment, class: "form-control", placeholder: "スタッフの対応についてコメントしてください" %></p>
    </div>

    <div class="mb-3">
      <strong><%= f.label :price_rating, "料金" %></strong>
      <div id="price_rating" class="my-2 rate"></div>
      <p class="text-muted mb-0"><%= f.text_field :price_comment, class: "form-control", placeholder: "料金についてコメントしてください" %></p>
    </div>

    <div class="mb-3">
      <strong><%= f.label :waiting_rating, "待ち時間" %></strong>
      <div id="waiting_rating" class="my-2 rate"></div>
      <p class="text-muted mb-0"><%= f.text_field :waiting_comment, class: "form-control", placeholder: "待ち時間についてコメントしてください" %></p>
    </div>

    <div class="mb-3">
      <strong><%= f.label :title, "レビューにタイトルをつける" %></strong>
      <p class="text-muted mb-0"><%= f.text_field :title, class: "form-control", placeholder: "タイトルを記入してください" %></p>
    </div>

    <div class="mb-3">
      <strong><%= f.label :body, "総合評価" %></strong>
      <div id="rating" class="my-2 rate"></div>
      <p class="text-muted mb-0"><%= f.text_area :body, rows: 6, class: "form-control", placeholder: "総合的な感想を記入してください。" %></p>
    </div>


    <div class="mb-3">
      <strong><%= f.label :animal_comment, "動物目線でひとこと！(任意)" %></strong>
      <p class="text-muted mb-0"><%= f.text_field :animal_comment, class: "form-control", placeholder: "例:広々していて過ごしやすかった！" %></p>
    </div>
    
    <div class="mb-3">
      <p>タグを選択</p>
      <% @tags.each do |tag| %>
        <%= check_box_tag "review[tag_ids][]", tag.id, @review.tags.include?(tag) %>
        <%= tag.tag %>
      <% end %>
      <div class="mt-3">
        <p>新しいタグを入力（カンマ区切りで複数可）</p>
        <%= text_field_tag "review[new_tag_names]", nil, placeholder: "例）夜間対応, 駐車場あり, 先生が優しい", class: "form-control" %>
      </div>
    </div>
    <%= f.submit "レビューを投稿する", class: "btn btn-warning w-100" %>
  </div>
  <% end %>
  </div>
</div>


<!--  星評価の設定 -->
<script>
  function initRaty(id, name) {
    const elem = document.querySelector(id);
    if (!elem) return;
    elem.innerHTML = '';

    raty(elem, {
      starOn: "<%= asset_path('star-on.png') %>",
      starHalf: "<%= asset_path('star-half.png') %>",
      starOff: "<%= asset_path('star-off.png') %>",
      half: true,
      targetKeep: true,
      scoreName: name
    });
  }

  // Turbolinks使用なら turbolinks:load、未使用なら DOMContentLoaded
  document.addEventListener("turbolinks:load", function() {
    initRaty('#cleanliness_rating', 'review[cleanliness_rating]');
    initRaty('#doctor_rating', 'review[doctor_rating]');
    initRaty('#staff_rating', 'review[staff_rating]');
    initRaty('#price_rating', 'review[price_rating]');
    initRaty('#waiting_rating', 'review[waiting_rating]');
    initRaty('#rating', 'review[rating]');
  });

  // 星評価のキャッシュ対策
  document.addEventListener("turbolinks:before-cache", function() {
    $('.raty-display, .rate').empty();
  });
</script>


